stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_BUILDKIT: 1
  GIT_DEPTH: 10

services:
  - docker:24.0.5-dind

# Cache cabal dependencies between runs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ~/.cabal/packages
    - ~/.cabal/store
    - dist-newstyle

# Test stage to validate the Hakyll build
test:
  stage: test
  image: haskell:9.4
  before_script:
    - cabal update
  script:
    - echo "Testing Beast Capital Hakyll build"
    - cabal build --dependencies-only
    - cabal build
    - cabal exec site build
    - echo "Build test completed successfully"
    - ls -la _site/
  artifacts:
    paths:
      - _site/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_MERGE_REQUEST_IID

build:
  stage: build
  image: docker:24.0.5
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image for Beast Capital website"
    - docker build --build-arg BUILDKIT_INLINE_CACHE=1 -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -t $CI_REGISTRY_IMAGE:latest .
    - echo "Pushing Docker image to GitLab Container Registry"
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
    - echo "Docker image pushed successfully"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

deploy:
  stage: deploy
  image: google/cloud-sdk:alpine
  before_script:
    - echo "Preparing deployment to Google Cloud Run"
    - apk add --no-cache curl jq
  script:
    - echo "Deploying Beast Capital website to Google Cloud Run"
    
    # Validate required environment variables
    - |
      if [ -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then
        echo "Error: GCP_SERVICE_ACCOUNT_KEY is not set"
        echo "Please add it in GitLab CI/CD Settings > Variables"
        exit 1
      fi
      if [ -z "$GCP_PROJECT_ID" ]; then
        echo "Error: GCP_PROJECT_ID is not set"
        echo "Please add it in GitLab CI/CD Settings > Variables"
        exit 1
      fi
    
    # Authenticate with Google Cloud
    - |
      echo "Authenticating with GCP..."
      # Write the service account key to a file, preserving newlines
      # Try base64 decode first (in case user encoded it), otherwise use as-is
      if echo "$GCP_SERVICE_ACCOUNT_KEY" | base64 -d > /tmp/gcloud-service-key.json 2>/dev/null; then
        echo "Service account key appears to be base64 encoded"
      else
        echo "Service account key used as raw JSON"
        # Use printf to preserve newlines and special characters
        printf '%s\n' "$GCP_SERVICE_ACCOUNT_KEY" > /tmp/gcloud-service-key.json
      fi
      
      # Verify the JSON is valid
      if ! jq . /tmp/gcloud-service-key.json > /dev/null 2>&1; then
        echo "Error: Service account key is not valid JSON"
        exit 1
      fi
    
    - gcloud auth activate-service-account --key-file=/tmp/gcloud-service-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud config set run/region us-central1
    
    # Configure Docker to use gcloud as a credential helper
    - gcloud auth configure-docker --quiet
    
    # Deploy to Cloud Run
    - |
      echo "Deploying to Cloud Run..."
      gcloud run deploy beast-capital-website \
        --image $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA \
        --platform managed \
        --region us-central1 \
        --allow-unauthenticated \
        --port 80 \
        --memory 512Mi \
        --cpu 1 \
        --min-instances 0 \
        --max-instances 10 \
        --concurrency 80 \
        --timeout 300 \
        --set-env-vars="ENV=production,BUILD_SHA=$CI_COMMIT_SHA,BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
        --labels="app=beast-capital,environment=production,version=$CI_COMMIT_SHORT_SHA" \
        --no-traffic || true
    
    # Get and display the service URL
    - |
      SERVICE_URL=$(gcloud run services describe beast-capital-website --platform managed --region us-central1 --format 'value(status.url)' 2>/dev/null)
      if [ -n "$SERVICE_URL" ]; then
        echo "✅ Beast Capital website deployed successfully!"
        echo "Service URL: $SERVICE_URL"
        echo "Build SHA: $CI_COMMIT_SHA"
      else
        echo "⚠️ Could not retrieve service URL, but deployment may have succeeded"
      fi
    
    # Test the deployed service
    - |
      if [ -n "$SERVICE_URL" ]; then
        echo "Testing deployed service..."
        if curl -f -s "$SERVICE_URL" | grep -q "Beast Capital"; then
          echo "✅ Service is responding correctly"
        else
          echo "⚠️ Service test inconclusive, but deployment succeeded"
        fi
      fi
    
    # Cleanup
    - rm -f /tmp/gcloud-service-key.json
    
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: production
    url: https://beast-capital-website-$GCP_PROJECT_ID.a.run.app
  timeout: 10m
