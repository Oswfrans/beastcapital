stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:20.10.16-dind

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build:
  stage: build
  image: docker:20.10.16
  script:
    - echo "Building Docker image for Beast Capital website"
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    - echo "Pushing Docker image to GitLab Container Registry"
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - develop

deploy:
  stage: deploy
  image: google/cloud-sdk:alpine
  script:
    - echo "Deploying Beast Capital website to Google Cloud Run"
    # Authenticate with Google Cloud
    - echo $GCP_SERVICE_ACCOUNT_KEY | base64 -d > gcloud-service-key.json
    - gcloud auth activate-service-account --key-file gcloud-service-key.json
    - gcloud config set project $GCP_PROJECT_ID
    
    # Configure Docker to use gcloud as a credential helper
    - gcloud auth configure-docker
    
    # Deploy to Cloud Run
    - gcloud run deploy beast-capital-website 
        --image $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA 
        --platform managed 
        --region us-central1 
        --allow-unauthenticated 
        --port 80 
        --memory 512Mi 
        --cpu 1 
        --max-instances 10 
        --set-env-vars="ENV=production"
    
    # Get the service URL
    - gcloud run services describe beast-capital-website --platform managed --region us-central1 --format 'value(status.url)'
  only:
    - main
  when: manual
  environment:
    name: production
    url: https://beast-capital-website-$GCP_PROJECT_ID.a.run.app